<!DOCTYPE html>
<html>
	<body onload="webGLStart();" style="width:100%; height:100%;">
		<center><canvas id="canvas" style="border: none;" width="1024px" height="768px"></canvas><br>
		<input type="range" id="size" value="0"><br>

		<script type="text/javascript" src="gltools.js"></script>
		<script type="text/javascript" src="gl.js"></script>
		<script id="shader-fs" type="x-shader/x-fragment">
			precision highp float;
			varying vec2 texmap;
			uniform float size;
			float rand(vec2 co){
				return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
			}
			const int max = 1024;
			vec2 randV(int i){
				vec2 co1 = vec2(float(i)/float(max), 0.0);
				vec2 co2 = vec2(co1.x, 0.5);
				return vec2(rand(co1), rand(co2));
			}
			vec2 findNearest(vec2 c, int block){
				float mindist = -1.0;
				vec2 nearest;
				for(int i=0;i<=max;i++){
					if(i>block) break;
					vec2 v = randV(i);
					float dist = distance(v, c);
					if(mindist < 0.0 || mindist > dist){
						mindist = dist;
						nearest = v;
					}
				}
				return nearest;
			}
			void main(){
				float v = rand(findNearest(texmap,int(size*float(max))));
				gl_FragColor = vec4(v,v,v,1.0);
			}
		</script>
		<script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 aVertexPosition;
			attribute vec2 aVertexTexmap;
			varying vec2 texmap;

			void main(void) {
				texmap=aVertexTexmap;
				gl_Position = vec4(aVertexPosition, 1.0);
			}
		</script>
		<script type="text/javascript">
			"use strict";
			function setUniforms() {
				gl.uniform1f(shaderProgram.size, sizeSlider.value/100.0);
			}
			function initBuffers() {
				var vertices = [
					-1.0, -1.0,  0.0,
					1.0, -1.0,  0.0,
					-1.0,  1.0,  0.0,

					1.0, -1.0,  0.0,
					1.0, 1.0,  0.0,
					-1.0,  1.0,  0.0,
				];
				renderer.addBuffer(vertices,3,shaderProgram.aVertexPosition);

				var texmap = [
					0.0,0.0,
					1.0,0.0,
					0.0,1.0,

					1.0,0.0,
					1.0,1.0,
					0.0,1.0,
				];
				renderer.addBuffer(texmap,2,shaderProgram.aVertexTexmap);
			}
			var gl;
			var shaderProgram;
			var renderer;
			function tick(){
				requestAnimFrame(tick);
				shaderProgram.bind();
				renderer.draw();
			}
			var sizeSlider;
			function webGLStart() {
				sizeSlider=document.getElementById("size");
				gl = initGL(canvas);
				gl.clearColor(0.0, 0.0, 0.0, 1.0);
				gl.enable(gl.CULL_FACE);

				shaderProgram = new ShaderProgram("shader",gl,setUniforms);
				shaderProgram.addAttribute("aVertexPosition");
				shaderProgram.addAttribute("aVertexTexmap");
				shaderProgram.addUniform("size");

				renderer = new Renderer(gl);
				initBuffers();
				tick();
			}
		</script>

	</body>
</html>
